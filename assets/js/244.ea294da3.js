(window.webpackJsonp=window.webpackJsonp||[]).push([[244],{656:function(t,e,v){"use strict";v.r(e);var _=v(42),s=Object(_.a)({},(function(){var t=this,e=t.$createElement,v=t._self._c||e;return v("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[v("h1",{attrs:{id:"rr下解决幻读的关键next-key-lock"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#rr下解决幻读的关键next-key-lock"}},[t._v("#")]),t._v(" RR下解决幻读的关键next-key lock")]),t._v(" "),v("p"),v("div",{staticClass:"table-of-contents"},[v("ul",[v("li",[v("a",{attrs:{href:"#大纲"}},[t._v("大纲")])]),v("li",[v("a",{attrs:{href:"#简介"}},[t._v("简介")])]),v("li",[v("a",{attrs:{href:"#什么是next-key-lock"}},[t._v("什么是next-key lock")])]),v("li",[v("a",{attrs:{href:"#什么情况下用到了它"}},[t._v("什么情况下用到了它")])]),v("li",[v("a",{attrs:{href:"#它帮我们做了什么"}},[t._v("它帮我们做了什么")]),v("ul",[v("li",[v("a",{attrs:{href:"#等于加行锁同时添加了间隙锁"}},[t._v("等于加行锁同时添加了间隙锁")])]),v("li",[v("a",{attrs:{href:"#next-key-lock的作用"}},[t._v("next-key lock的作用")])]),v("li",[v("a",{attrs:{href:"#next-key-lock加锁原则"}},[t._v("next-key lock加锁原则")])]),v("li",[v("a",{attrs:{href:"#next-key-lock是如何发挥作用的"}},[t._v("next-key lock是如何发挥作用的")])]),v("li",[v("a",{attrs:{href:"#next-key-lock是动态变动的"}},[t._v("next-key lock是动态变动的")])])])]),v("li",[v("a",{attrs:{href:"#它会导致什么问题"}},[t._v("它会导致什么问题")]),v("ul",[v("li",[v("a",{attrs:{href:"#容易出现死锁"}},[t._v("容易出现死锁")])])])]),v("li",[v("a",{attrs:{href:"#总结重点"}},[t._v("总结重点")]),v("ul",[v("li",[v("a",{attrs:{href:"#能分析出各种场景下next-key-lock的情况"}},[t._v("能分析出各种场景下next-key lock的情况")])]),v("li",[v("a",{attrs:{href:"#nexk-key-lock的简单实现原理"}},[t._v("nexk-key lock的简单实现原理")])]),v("li",[v("a",{attrs:{href:"#一些典型的或者容易忽略的注意事项"}},[t._v("一些典型的或者容易忽略的注意事项")])])])]),v("li",[v("a",{attrs:{href:"#参考资料"}},[t._v("参考资料")])])])]),v("p"),t._v(" "),v("h2",{attrs:{id:"大纲"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#大纲"}},[t._v("#")]),t._v(" 大纲")]),t._v(" "),v("p",[t._v("要想思路完整, 多问自己几个问题")]),t._v(" "),v("ol",[v("li",[t._v("什么是next-key lock")]),t._v(" "),v("li",[t._v("什么情况下用到了它")]),t._v(" "),v("li",[t._v("它帮我们做了什么")]),t._v(" "),v("li",[t._v("它会导致什么问题")])]),t._v(" "),v("h2",{attrs:{id:"简介"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#简介"}},[t._v("#")]),t._v(" 简介")]),t._v(" "),v("blockquote",[v("p",[t._v("本文尝试介绍next-key lock.")])]),t._v(" "),v("h2",{attrs:{id:"什么是next-key-lock"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#什么是next-key-lock"}},[t._v("#")]),t._v(" 什么是next-key lock")]),t._v(" "),v("blockquote",[v("p",[t._v("首先说说mysql的锁, 有三种锁算法:")]),t._v(" "),v("blockquote",[v("ol",[v("li",[t._v("record lock: 单行上锁")]),t._v(" "),v("li",[t._v("gap lock: 间隙锁")]),t._v(" "),v("li",[t._v("next-key lock: 1+2, 锁定单行时也锁定一个范围.")])])]),t._v(" "),v("p",[t._v("next-key lock是为了避免幻读而引入的锁, 在一定程度上解决了幻读.")])]),t._v(" "),v("h2",{attrs:{id:"什么情况下用到了它"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#什么情况下用到了它"}},[t._v("#")]),t._v(" 什么情况下用到了它")]),t._v(" "),v("blockquote",[v("p",[t._v("前面说到, 是为了解决幻读的问题, 那mysql是什么情况使用到了它呢?")]),t._v(" "),v("p",[t._v("答案是, 在"),v("code",[t._v("repeatable read")]),t._v("隔离级别下引入了next-key lock, 但RC下也是存在间隙锁的, 相对较复杂.")])]),t._v(" "),v("h2",{attrs:{id:"它帮我们做了什么"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#它帮我们做了什么"}},[t._v("#")]),t._v(" 它帮我们做了什么")]),t._v(" "),v("blockquote",[v("p",[t._v("一般只在RR下存在")])]),t._v(" "),v("h3",{attrs:{id:"等于加行锁同时添加了间隙锁"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#等于加行锁同时添加了间隙锁"}},[t._v("#")]),t._v(" 等于加行锁同时添加了间隙锁")]),t._v(" "),v("blockquote",[v("p",[t._v("因为next-key lock=行锁+间隙锁, 因此锁定行数据时, 会同时加上间隙锁.")])]),t._v(" "),v("h3",{attrs:{id:"next-key-lock的作用"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#next-key-lock的作用"}},[t._v("#")]),t._v(" next-key lock的作用")]),t._v(" "),v("blockquote",[v("p",[t._v("在RR隔离级别下的事务中, 出现"),v("code",[t._v("增删改")]),t._v("则会使用next-key lock, 此时不仅锁定了当前行, 也锁定了前后的间隙, 使得无法在间隙中进行insert操作.")]),t._v(" "),v("p",[t._v("间隙锁是会将当前行到两边的数据行中间的间隙上锁, 并且是一个"),v("code",[t._v("左开右闭")]),t._v("区间.")])]),t._v(" "),v("h3",{attrs:{id:"next-key-lock加锁原则"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#next-key-lock加锁原则"}},[t._v("#")]),t._v(" next-key lock加锁原则")]),t._v(" "),v("blockquote",[v("p",[v("strong",[t._v("1. 以next-key lock为最小单位")])]),t._v(" "),v("p",[v("strong",[t._v("2. 索引上的等值查询, 且是唯一索引, 降级为行锁")])]),t._v(" "),v("p",[v("strong",[t._v("3. 索引上的等值查询, 向右遍历到最后一个不满足条件时, 右闭改为右开, 降级为间隙锁")])]),t._v(" "),v("p",[v("strong",[t._v("4. limit能减小间隙锁范围, 指定n则最多遍历到n个就结束的右闭区间")])]),t._v(" "),v("p",[v("strong",[t._v("5. 普通索引上是存在主键索引的, 因此"),v("code",[t._v("非覆盖索引")]),t._v("同时锁定了普通索引和主键索引的组合")])]),t._v(" "),v("p",[v("strong",[t._v("6. order by desc会再向"),v("code",[t._v("左(实际上倒序后还是向右)")]),t._v("多遍历一次, 直到最后两个不满足条件时结束")])]),t._v(" "),v("p",[v("strong",[t._v("7. 只有访问到的对象才会加锁(覆盖索引不会访问主键,因此不会锁住主键)")])]),t._v(" "),v("p",[v("strong",[t._v("8. 有唯一性的索引上的范围查询, 会向右遍历到最后一个不满足条件的索引, 并且"),v("code",[t._v("不降级")])])]),t._v(" "),v("p",[v("u",[t._v("RC下的优化原则")])]),t._v(" "),v("p",[v("strong",[t._v("语句执行过程中会加行锁, 执行完后, 会把不满足条件的行释放锁")])])]),t._v(" "),v("h3",{attrs:{id:"next-key-lock是如何发挥作用的"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#next-key-lock是如何发挥作用的"}},[t._v("#")]),t._v(" next-key lock是如何发挥作用的")]),t._v(" "),v("h4",{attrs:{id:"场景一"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#场景一"}},[t._v("#")]),t._v(" 场景一")]),t._v(" "),v("blockquote",[v("p",[t._v("表结构: column: id,c,d;   id是主键, c是index")]),t._v(" "),v("p",[t._v("表中已有数据: (0,0,0),(5,5,5),(10,10,10),(15,15,15),(20,20,20),(25,25,25)")])]),t._v(" "),v("table",[v("thead",[v("tr",[v("th",{staticStyle:{"text-align":"left"}}),t._v(" "),v("th",[t._v("session A")]),t._v(" "),v("th",[t._v("session B")]),t._v(" "),v("th",[t._v("session C")])])]),t._v(" "),v("tbody",[v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T1")]),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("select * from t where d=5 for update;")]),t._v(" "),v("td"),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T2")]),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("insert into t values(8,8,8);"),v("br"),v("strong",[t._v("(block)")])]),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T3")]),t._v(" "),v("td"),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("insert into t values(11,11,11);"),v("br"),v("strong",[t._v("(block)")])])])])]),t._v(" "),v("blockquote",[v("p",[v("strong",[t._v("场景一说明")])]),t._v(" "),v("ol",[v("li",[t._v("T1, 排他锁锁定全表数据(因为d没有索引).")]),t._v(" "),v("li",[t._v("T2/T3, 插入数据都被阻塞, 因为全表都加入了next-key lock., "),v("strong",[t._v("所有insert和update(更新原有数据)都无法执行, 但update不存在数据是可以的.")])])])]),t._v(" "),v("h4",{attrs:{id:"场景二-锁发生在普通索引上"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#场景二-锁发生在普通索引上"}},[t._v("#")]),t._v(" 场景二, 锁发生在普通索引上")]),t._v(" "),v("table",[v("thead",[v("tr",[v("th",{staticStyle:{"text-align":"left"}}),t._v(" "),v("th",[t._v("session A")]),t._v(" "),v("th",[t._v("session B")]),t._v(" "),v("th",[t._v("session C")])])]),t._v(" "),v("tbody",[v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T1")]),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("select * from t where c=5 for update;")]),t._v(" "),v("td"),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T2")]),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("insert into t values(8,8,8);"),v("br"),v("strong",[t._v("(block)")])]),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T3")]),t._v(" "),v("td"),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("update t set d=12 where c=10;"),v("br"),v("strong",[t._v("(update成功)")])])]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T4")]),t._v(" "),v("td"),t._v(" "),v("td"),t._v(" "),v("td",[t._v("update t set c=9 where id=10;"),v("br"),v("strong",[t._v("(block)")])])])])]),t._v(" "),v("blockquote",[v("p",[v("strong",[t._v("场景二说明")])]),t._v(" "),v("ol",[v("li",[t._v("T1, 根据索引锁定c(0,10), 所有c列值在此区间的都被阻塞. "),v("strong",[t._v("根据c=5, 先锁定最小单位(0,5]的next-key lock, 由于是等值查询, 会向右遍历到不满足的索引, 并降级为间隙锁,  因此最终为(0,10).")])]),t._v(" "),v("li",[t._v("T3, 不在间隙锁索引区间中, 成功执行.")]),t._v(" "),v("li",[t._v("T4, "),v("strong",[t._v("id虽然不在锁定区间内, 但想把id=10这条记录的c列更新到锁定区间范围内, 其实相当于在锁定区间insert数据, 因此会阻塞.")])])])]),t._v(" "),v("h4",{attrs:{id:"场景三-1-但凡事有特例-看下面"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#场景三-1-但凡事有特例-看下面"}},[t._v("#")]),t._v(" 场景三(1), 但凡事有特例, 看下面")]),t._v(" "),v("blockquote",[v("p",[t._v("表结构: column: id,c,d; id是主键, c是唯一索引.")]),t._v(" "),v("p",[t._v("表数据: (0,0,0),(5,5,5),(10,10,10),(15,15,15),(20,20,20),(25,25,25)")])]),t._v(" "),v("table",[v("thead",[v("tr",[v("th",{staticStyle:{"text-align":"left"}}),t._v(" "),v("th",[t._v("session A")]),t._v(" "),v("th",[t._v("session B")]),t._v(" "),v("th",[t._v("session C")])])]),t._v(" "),v("tbody",[v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T1")]),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("select * from t where id=5 for update;")]),t._v(" "),v("td"),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T2")]),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("insert into t values(4,4,4);"),v("br"),v("strong",[t._v("(insert成功)")])]),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T3")]),t._v(" "),v("td"),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("insert into t values(6,6,6);"),v("br"),v("strong",[t._v("(insert成功)")])])])])]),t._v(" "),v("blockquote",[v("p",[v("strong",[t._v("场景三说明")])]),t._v(" "),v("ol",[v("li",[t._v("T1, 根据索引锁定, 由于索引带有"),v("code",[t._v("唯一性")]),t._v(", 故改为record lock, 只锁定单行.")]),t._v(" "),v("li",[t._v("T2/T3, 由于T1只锁定了单行, 故都能成功insert.")])]),t._v(" "),v("p",[t._v("**查询的索引含有唯一属性的时候，Next-Key Lock 会进行优化，将其降级为Record Lock，即仅锁住索引本身，不是范围。 **")]),t._v(" "),v("p",[v("strong",[t._v("注意: 通过主键或唯一索引来锁定不存在的值，也会产生gap锁。")])]),t._v(" "),v("p",[v("strong",[t._v("insert只会产生排他锁(X), 没有next-key lock")])]),t._v(" "),v("p",[v("strong",[t._v("update一条不存在的数据, 不会产生锁")])])]),t._v(" "),v("h4",{attrs:{id:"场景三-2-锁定一行不存在数据时"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#场景三-2-锁定一行不存在数据时"}},[t._v("#")]),t._v(" 场景三(2), 锁定一行不存在数据时")]),t._v(" "),v("table",[v("thead",[v("tr",[v("th",{staticStyle:{"text-align":"left"}}),t._v(" "),v("th",[t._v("session A")]),t._v(" "),v("th",[t._v("session B")]),t._v(" "),v("th",[t._v("session C")]),t._v(" "),v("th",[t._v("session D")])])]),t._v(" "),v("tbody",[v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T1")]),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("select * from t where c=30 for update;")]),t._v(" "),v("td"),t._v(" "),v("td"),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T2")]),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("insert into t values(26,26,26)"),v("br"),v("strong",[t._v("(block)")])]),t._v(" "),v("td"),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T3")]),t._v(" "),v("td"),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("insert into t values(100,100,100);"),v("br"),v("strong",[t._v("(block)")])]),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T4")]),t._v(" "),v("td"),t._v(" "),v("td"),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("insert into t values(24,24,24)"),v("br"),v("strong",[t._v("(ok)")])])])])]),t._v(" "),v("blockquote",[v("p",[v("strong",[t._v("场景三(2)说明")])]),t._v(" "),v("ol",[v("li",[t._v("T1, for update不存在的行, 产生了间隙锁, 锁范围是(25, +∞)")]),t._v(" "),v("li",[t._v("T2/T3, 依照锁范围阻塞.")]),t._v(" "),v("li",[t._v("T4, 不在锁范围, insert成功.")])])]),t._v(" "),v("h4",{attrs:{id:"场景三-3-锁定一行不存在数据时-使用lock-in-share-mode"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#场景三-3-锁定一行不存在数据时-使用lock-in-share-mode"}},[t._v("#")]),t._v(" 场景三(3), 锁定一行不存在数据时, 使用lock in share mode")]),t._v(" "),v("blockquote",[v("p",[t._v("结果与场景三(2)相同, "),v("strong",[t._v("for update与lock in share mode都会产生nexk-key lock")])])]),t._v(" "),v("h4",{attrs:{id:"场景四-update相当于在锁定区间insert"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#场景四-update相当于在锁定区间insert"}},[t._v("#")]),t._v(" 场景四, update相当于在锁定区间insert")]),t._v(" "),v("blockquote",[v("p",[t._v("以上场景中的session B/C改为使用update, 也会有一样的问题, 因为gap lock是锁定的索引, "),v("strong",[t._v("如果update的结果相当于在索引中插入数据")]),t._v(", 一样会被阻塞.")])]),t._v(" "),v("table",[v("thead",[v("tr",[v("th",{staticStyle:{"text-align":"left"}}),t._v(" "),v("th",[t._v("session A")]),t._v(" "),v("th",[t._v("session B")]),t._v(" "),v("th",[t._v("session C")]),t._v(" "),v("th",[t._v("session D")])])]),t._v(" "),v("tbody",[v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T1")]),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("select * from t where c=5 for update;")]),t._v(" "),v("td"),t._v(" "),v("td"),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T2")]),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("update t set c=5 where id=0;"),v("br"),v("strong",[t._v("(block)")])]),t._v(" "),v("td"),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T3")]),t._v(" "),v("td"),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("update t set c=10 where id=0;"),v("br"),v("strong",[t._v("(block)")])]),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T4")]),t._v(" "),v("td"),t._v(" "),v("td"),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("update t set c=11 where id=0;"),v("br"),v("strong",[t._v("(ok)")])])])])]),t._v(" "),v("blockquote",[v("p",[v("strong",[t._v("场景四说明")])]),t._v(" "),v("ol",[v("li",[t._v("T1, 产生间隙锁, 等值查询会向右遍历, 因此锁范围是(0,10]")]),t._v(" "),v("li",[t._v("T2/T3, 根据锁范围, 阻塞.")]),t._v(" "),v("li",[t._v("T4, 执行成功.")])])]),t._v(" "),v("h4",{attrs:{id:"场景五-普通索引锁定区间需要与主键组合判断"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#场景五-普通索引锁定区间需要与主键组合判断"}},[t._v("#")]),t._v(" 场景五, 普通索引锁定区间需要与主键组合判断")]),t._v(" "),v("blockquote",[v("p",[t._v("根据"),v("code",[t._v("普通索引")]),t._v("锁定区间时, 还是有一定区别的, 下面给出场景案例.")])]),t._v(" "),v("table",[v("thead",[v("tr",[v("th",{staticStyle:{"text-align":"left"}}),t._v(" "),v("th",[t._v("session A")]),t._v(" "),v("th",[t._v("session B")]),t._v(" "),v("th",[t._v("session C")])])]),t._v(" "),v("tbody",[v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T1")]),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("select * from t where c=5 for update;")]),t._v(" "),v("td"),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T2")]),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("insert into t values(9, 10, 10);"),v("br"),v("strong",[t._v("(block)")])]),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T3")]),t._v(" "),v("td"),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("insert into t values(11, 10, 10);"),v("br"),v("strong",[t._v("(ok)")])])])])]),t._v(" "),v("blockquote",[v("p",[t._v("以上场景, 间隙锁的范围是(id,c)->(0,0)~(10,10)之间的间隙都会被锁住, 而session C是(11,10)不在返回内, 因此可以insert成功.")]),t._v(" "),v("p",[t._v("此处是根据索引(btree)的有序性.")])]),t._v(" "),v("h4",{attrs:{id:"场景六-1-只有被访问到的索引才会加锁"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#场景六-1-只有被访问到的索引才会加锁"}},[t._v("#")]),t._v(" 场景六(1), 只有被访问到的索引才会加锁")]),t._v(" "),v("table",[v("thead",[v("tr",[v("th",{staticStyle:{"text-align":"left"}}),t._v(" "),v("th",[t._v("session A")]),t._v(" "),v("th",[t._v("session B")]),t._v(" "),v("th",[t._v("session C")])])]),t._v(" "),v("tbody",[v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T1")]),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("select id from t where c=5 lock in share mode;")]),t._v(" "),v("td"),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T2")]),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("update t set d=100 where id=5;"),v("br"),v("strong",[t._v("(ok)")])]),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T3")]),t._v(" "),v("td"),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("insert t values(6,6,6);"),v("br"),v("strong",[t._v("(block)")])])])])]),t._v(" "),v("blockquote",[v("p",[v("strong",[t._v("场景六说明")])]),t._v(" "),v("ol",[v("li",[t._v("T1, 给c=5这一行加上读锁, 并产生next-key lock, 锁定范围是c(0, 10);")]),t._v(" "),v("li",[t._v("T2, 更新id=5的行, "),v("strong",[t._v("由于T1使用的是覆盖索引, 只锁定c=5这个索引, 并没有锁定主键索引, 因此更新主键索引对应的数据行, 是可以的")])]),t._v(" "),v("li",[t._v("T3, insert的c列在锁定范围内, 故阻塞.")])])]),t._v(" "),v("h4",{attrs:{id:"场景六-2-todo"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#场景六-2-todo"}},[t._v("#")]),t._v(" 场景六(2), TODO")]),t._v(" "),v("table",[v("thead",[v("tr",[v("th",{staticStyle:{"text-align":"left"}}),t._v(" "),v("th",[t._v("session A")]),t._v(" "),v("th",[t._v("session B")]),t._v(" "),v("th",[t._v("session C")])])]),t._v(" "),v("tbody",[v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T1")]),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("select id from t where c=5 for update;")]),t._v(" "),v("td"),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T2")]),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("update t set d=100 where id=5;"),v("br"),v("strong",[t._v("(block)")])]),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T3")]),t._v(" "),v("td"),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("insert t values(6,6,6);"),v("br"),v("strong",[t._v("(block)")])])])])]),t._v(" "),v("h4",{attrs:{id:"场景七-1-主键索引的范围锁定"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#场景七-1-主键索引的范围锁定"}},[t._v("#")]),t._v(" 场景七(1), 主键索引的范围锁定")]),t._v(" "),v("table",[v("thead",[v("tr",[v("th",{staticStyle:{"text-align":"left"}}),t._v(" "),v("th",[t._v("session A")]),t._v(" "),v("th",[t._v("session B")]),t._v(" "),v("th",[t._v("session C")])])]),t._v(" "),v("tbody",[v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T1")]),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("select * from t where id>=10 and id<16 for update;")]),t._v(" "),v("td"),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T2")]),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("insert into t values(11, 11, 11);"),v("br"),v("strong",[t._v("(block)")])]),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T3")]),t._v(" "),v("td"),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("insert into t values(21, 21, 21);"),v("br"),v("strong",[t._v("(ok)")]),v("br"),t._v("insert into t values(19, 19, 19);"),v("br"),v("strong",[t._v("(block)")])])])])]),t._v(" "),v("blockquote",[v("p",[v("strong",[t._v("场景七说明")])]),t._v(" "),v("ol",[v("li",[t._v("T1, 先由id=10的主键等值查询,  降级为行锁, 锁定id=10单行, 但由于范围查询, 故向右遍历, 直到不满足碰到不满足条件的索引(条件为id<16)停下来, 锁定范围是id[10,20]")]),t._v(" "),v("li",[t._v("T2/T3, 根据锁定范围可知.")])])]),t._v(" "),v("h4",{attrs:{id:"场景七-2-主键范围锁定的扩展场景"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#场景七-2-主键范围锁定的扩展场景"}},[t._v("#")]),t._v(" 场景七(2), 主键范围锁定的扩展场景")]),t._v(" "),v("table",[v("thead",[v("tr",[v("th",{staticStyle:{"text-align":"left"}}),t._v(" "),v("th",[t._v("session A")]),t._v(" "),v("th",[t._v("session B")]),t._v(" "),v("th",[t._v("session C")])])]),t._v(" "),v("tbody",[v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T1")]),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("select * from t where id>14 and id<16 for update;")]),t._v(" "),v("td"),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T2")]),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("update t set d=100 where id=10;"),v("br"),v("strong",[t._v("(ok)")]),v("br"),t._v("insert into t values(11, 11, 11);"),v("br"),v("strong",[t._v("(block)")])]),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T3")]),t._v(" "),v("td"),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("update t set d=100 where id=20;"),v("br"),v("strong",[t._v("(block)")]),v("br"),t._v("insert into t values(19, 19, 19);"),v("br"),v("strong",[t._v("(block)")])])])])]),t._v(" "),v("blockquote",[v("p",[v("strong",[t._v("场景七(2)说明")])]),t._v(" "),v("ol",[v("li",[t._v("T1, 首先根据id>14进行范围查询, 直到碰到不满足条件的索引(条件为id<16)停下来, 锁定范围是id(10,20]")]),t._v(" "),v("li",[t._v("T2/T3, 根据锁定范围可知结果.")])]),t._v(" "),v("p",[v("strong",[t._v("与场景七(1)差别在于T1时刻没有等值查询")])])]),t._v(" "),v("h4",{attrs:{id:"场景七-3-唯一属性索引的范围锁"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#场景七-3-唯一属性索引的范围锁"}},[t._v("#")]),t._v(" 场景七(3), 唯一属性索引的范围锁")]),t._v(" "),v("table",[v("thead",[v("tr",[v("th",{staticStyle:{"text-align":"left"}}),t._v(" "),v("th",[t._v("session A")]),t._v(" "),v("th",[t._v("session B")]),t._v(" "),v("th",[t._v("session C")]),t._v(" "),v("th",[t._v("session D")])])]),t._v(" "),v("tbody",[v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T1")]),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("select * from t where id>10 and id<=15 for update;")]),t._v(" "),v("td"),t._v(" "),v("td"),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T2")]),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("update t set d=100 where id=10"),v("br"),v("strong",[t._v("(block)")])]),t._v(" "),v("td"),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T3")]),t._v(" "),v("td"),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("insert into t values(19, 19, 19);"),v("br"),v("strong",[t._v("(block)")])]),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T4")]),t._v(" "),v("td"),t._v(" "),v("td"),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("update t set d=100 where id=20"),v("br"),v("strong",[t._v("(block)")])])])])]),t._v(" "),v("blockquote",[v("p",[v("strong",[t._v("场景七(3)说明")])]),t._v(" "),v("ol",[v("li",[t._v("T1, 锁定范围是id(10,20], 范围查询到id=15, 但是"),v("strong",[t._v("唯一性的索引的范围查询上需要向右查询, 就算最后的索引正好满足条件")])])])]),t._v(" "),v("h4",{attrs:{id:"场景八-limit语句加锁"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#场景八-limit语句加锁"}},[t._v("#")]),t._v(" 场景八, limit语句加锁")]),t._v(" "),v("blockquote",[v("p",[t._v("假设表数据在原有基础上, 增加一行(30,10,30)")])]),t._v(" "),v("table",[v("thead",[v("tr",[v("th",{staticStyle:{"text-align":"left"}}),t._v(" "),v("th",[t._v("session A")]),t._v(" "),v("th",[t._v("session B")])])]),t._v(" "),v("tbody",[v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T1")]),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("delete from t where c=10 limit 2;")]),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T2")]),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("insert into t values(12, 12, 12);"),v("br"),v("strong",[t._v("(ok)")])])])])]),t._v(" "),v("blockquote",[v("p",[v("strong",[t._v("场景八说明")])]),t._v(" "),v("ol",[v("li",[t._v("T1, 因为limit 2导致索引遍历只做到第二个c=10, 不会继续向右遍历, 此时间隙锁范围减小, 锁范围是(c=10,id=10~c=10,id=30]")])]),t._v(" "),v("p",[v("strong",[t._v("如果T1不加limit, 则锁范围是(c=10,id=10~c=15,id=15)")])])]),t._v(" "),v("h4",{attrs:{id:"场景九-死锁了"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#场景九-死锁了"}},[t._v("#")]),t._v(" 场景九, 死锁了?")]),t._v(" "),v("table",[v("thead",[v("tr",[v("th",{staticStyle:{"text-align":"left"}}),t._v(" "),v("th",[t._v("session A")]),t._v(" "),v("th",[t._v("session B")])])]),t._v(" "),v("tbody",[v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T1")]),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("select id from t where c=10 lock in share mode;")]),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T2")]),t._v(" "),v("td"),t._v(" "),v("td",[t._v("begin;"),v("br"),t._v("update t set d=100 where c=10;"),v("br"),v("strong",[t._v("(block)")])])]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T3")]),t._v(" "),v("td",[t._v("insert into t values(8, 8, 8);")]),t._v(" "),v("td")]),t._v(" "),v("tr",[v("td",{staticStyle:{"text-align":"left"}},[t._v("T4")]),t._v(" "),v("td"),t._v(" "),v("td",[v("strong",[t._v("Deadlock found ...")])])])])]),t._v(" "),v("blockquote",[v("p",[v("strong",[t._v("场景九说明")])]),t._v(" "),v("ol",[v("li",[t._v("T1, 语句加了next-key lock, 锁范围是(5,15].")]),t._v(" "),v("li",[t._v("T2, update语句也要加上next-key lock, 锁定范围是(5,10], 但因为行锁冲突, 进入锁等待.")]),t._v(" "),v("li",[t._v("T3, 由于session A的insert会被session B的间隙锁阻塞, 因此mysql发现死锁.")])]),t._v(" "),v("p",[v("strong",[t._v("虽然T2时刻是在锁等待, 但是update语句的next-key lock是分间隙锁和行锁分开执行的, 先加间隙锁, 并且加锁成功, 加行锁才进入了锁等待, 最后导致死锁.")])])]),t._v(" "),v("h3",{attrs:{id:"next-key-lock是动态变动的"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#next-key-lock是动态变动的"}},[t._v("#")]),t._v(" next-key lock是动态变动的")]),t._v(" "),v("p",[t._v("场景:")]),t._v(" "),v("blockquote",[v("p",[t._v("session A中先for update锁定一个区间, 然后session B更新在区间中的一行数据到区间外并提交事务, 之后session C再将其他行数据更新到区间边缘(session B操作之前本不在锁定区间中), 此时操作被阻塞.")])]),t._v(" "),v("h2",{attrs:{id:"它会导致什么问题"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#它会导致什么问题"}},[t._v("#")]),t._v(" 它会导致什么问题")]),t._v(" "),v("blockquote",[v("p",[t._v("next-key lock帮助我们一定程度上解决了幻读问题, 它除了牺牲性能, 还有什么问题?")])]),t._v(" "),v("h3",{attrs:{id:"容易出现死锁"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#容易出现死锁"}},[t._v("#")]),t._v(" 容易出现死锁")]),t._v(" "),v("blockquote",[v("p",[t._v("在本专题的另一篇文章"),v("RouterLink",{attrs:{to:"/villa/mysql/mysql的事务隔离级别介绍.html"}},[t._v("mysql的事务隔离级别介绍")]),t._v("中说明了RR下出现死锁的问题, 其实就是由间隙锁导致的一个常见问题, 在问题下方也附上了解决方案.")],1)]),t._v(" "),v("h2",{attrs:{id:"总结重点"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#总结重点"}},[t._v("#")]),t._v(" 总结重点")]),t._v(" "),v("h3",{attrs:{id:"能分析出各种场景下next-key-lock的情况"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#能分析出各种场景下next-key-lock的情况"}},[t._v("#")]),t._v(" 能分析出各种场景下next-key lock的情况")]),t._v(" "),v("h3",{attrs:{id:"nexk-key-lock的简单实现原理"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#nexk-key-lock的简单实现原理"}},[t._v("#")]),t._v(" nexk-key lock的简单实现原理")]),t._v(" "),v("h3",{attrs:{id:"一些典型的或者容易忽略的注意事项"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#一些典型的或者容易忽略的注意事项"}},[t._v("#")]),t._v(" 一些典型的或者容易忽略的注意事项")]),t._v(" "),v("ol",[v("li",[t._v("update也会加next-key lock")])]),t._v(" "),v("h2",{attrs:{id:"参考资料"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[t._v("#")]),t._v(" 参考资料")]),t._v(" "),v("p",[v("a",{attrs:{href:"https://www.cnblogs.com/zhoujinyi/p/3435982.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("资料1"),v("OutboundLink")],1)]),t._v(" "),v("p",[v("a",{attrs:{href:"MySQL%E5%AE%9E%E6%88%9845%E8%AE%B2"}},[t._v("资料2")])])])}),[],!1,null,null,null);e.default=s.exports}}]);