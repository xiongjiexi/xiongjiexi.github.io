(window.webpackJsonp=window.webpackJsonp||[]).push([[270],{683:function(t,s,e){"use strict";e.r(s);var a=e(42),n=Object(a.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"再来给你解释一次事务隔离级别的实现"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#再来给你解释一次事务隔离级别的实现"}},[t._v("#")]),t._v(" 再来给你解释一次事务隔离级别的实现")]),t._v(" "),e("blockquote",[e("p",[t._v("折腾事务隔离级别有几天了, 但是自己始终有些在雾里看花的感觉, 因此这篇旨在弄懂事务隔离级别的实现, 让自己知其然也知其所以然.")])]),t._v(" "),e("h3",{attrs:{id:"本文中案例使用的表结构和数据如下"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#本文中案例使用的表结构和数据如下"}},[t._v("#")]),t._v(" 本文中案例使用的表结构和数据如下")]),t._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("t"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("id"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DEFAULT")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("d"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DEFAULT")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PRIMARY")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("id"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ENGINE")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("InnoDB")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DEFAULT")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CHARSET")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("utf8mb4"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("INSERT")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("INTO")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("t"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("VALUES")]),t._v(" \n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("25")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("25")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("25")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("h2",{attrs:{id:"read-uncommitted"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#read-uncommitted"}},[t._v("#")]),t._v(" read uncommitted")]),t._v(" "),e("p",[t._v("场景案例")]),t._v(" "),e("h3",{attrs:{id:"事务a的update或insert未提交-session-b能看到"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#事务a的update或insert未提交-session-b能看到"}},[t._v("#")]),t._v(" 事务A的update或insert未提交, session B能看到")]),t._v(" "),e("h4",{attrs:{id:"update执行未提交"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#update执行未提交"}},[t._v("#")]),t._v(" update执行未提交")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"left"}}),t._v(" "),e("th",[t._v("session A")]),t._v(" "),e("th",[t._v("session B")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T1")]),t._v(" "),e("td",[t._v("begin;")]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T2")]),t._v(" "),e("td"),t._v(" "),e("td",[t._v("select * from t where id=5"),e("br"),e("strong",[t._v("result: (5,5,5)")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T3")]),t._v(" "),e("td",[t._v("update t set d=100 where id=5;")]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T4")]),t._v(" "),e("td"),t._v(" "),e("td",[t._v("select * from t where id=5"),e("br"),e("strong",[t._v("result: (5,5,100)")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T5")]),t._v(" "),e("td",[t._v("commit/rollback")]),t._v(" "),e("td")])])]),t._v(" "),e("h4",{attrs:{id:"insert执行未提交"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#insert执行未提交"}},[t._v("#")]),t._v(" insert执行未提交")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"left"}}),t._v(" "),e("th",[t._v("session A")]),t._v(" "),e("th",[t._v("session B")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T1")]),t._v(" "),e("td",[t._v("begin;")]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T2")]),t._v(" "),e("td"),t._v(" "),e("td",[t._v("select * from t where id>0 and id<10"),e("br"),e("strong",[t._v("result: (5,5,5)")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T3")]),t._v(" "),e("td",[t._v("insert into t values(6,6,6);")]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T4")]),t._v(" "),e("td"),t._v(" "),e("td",[t._v("select * from t where id>0 and id<10"),e("br"),e("strong",[t._v("result: (5,5,5),(6,6,6)")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T5")]),t._v(" "),e("td",[t._v("commit/rollback")]),t._v(" "),e("td")])])]),t._v(" "),e("h3",{attrs:{id:"事务a改变了行数据-事务b的update被阻塞"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#事务a改变了行数据-事务b的update被阻塞"}},[t._v("#")]),t._v(" 事务A改变了行数据, 事务B的update被阻塞")]),t._v(" "),e("h4",{attrs:{id:"insert数据"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#insert数据"}},[t._v("#")]),t._v(" insert数据")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"left"}}),t._v(" "),e("th",[t._v("session A")]),t._v(" "),e("th",[t._v("session B")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T1")]),t._v(" "),e("td",[t._v("begin;")]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T2")]),t._v(" "),e("td"),t._v(" "),e("td",[t._v("select * from t where id>0 and id<10 "),e("strong",[t._v("result: (5,5,5)")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T3")]),t._v(" "),e("td",[t._v("insert into t values(6,6,6);")]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T4")]),t._v(" "),e("td"),t._v(" "),e("td",[t._v("select * from t where id>0 and id<10 "),e("strong",[t._v("result: (5,5,5),(6,6,6)")]),e("br"),t._v("update t set d=200 where d=6;"),e("br"),e("strong",[t._v("(Affected row: 0)")]),e("br"),t._v("update t set d=200 where id=6"),e("br"),e("strong",[t._v("(执行阻塞)")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T5")]),t._v(" "),e("td",[t._v("commit/rollback")]),t._v(" "),e("td")])])]),t._v(" "),e("h4",{attrs:{id:"delete数据"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#delete数据"}},[t._v("#")]),t._v(" delete数据")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"left"}}),t._v(" "),e("th",[t._v("session A")]),t._v(" "),e("th",[t._v("session B")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T1")]),t._v(" "),e("td",[t._v("begin;")]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T2")]),t._v(" "),e("td"),t._v(" "),e("td",[t._v("select * from t where id>0 and id<10 "),e("strong",[t._v("result: (5,5,5)")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T3")]),t._v(" "),e("td",[t._v("delete from t where id=5;")]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T4")]),t._v(" "),e("td"),t._v(" "),e("td",[t._v("select * from t where id>0 and id<10 "),e("br"),e("strong",[t._v("result: 0 rows")]),t._v(" "),e("br"),t._v("update t set d=200 where d=5; "),e("br"),e("strong",[t._v("(执行阻塞)")]),t._v(" "),e("br"),t._v("update t set d=200 where id=5 "),e("strong",[t._v("(执行阻塞)")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T5")]),t._v(" "),e("td",[t._v("commit/rollback")]),t._v(" "),e("td")])])]),t._v(" "),e("h3",{attrs:{id:"场景说明-实现原理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#场景说明-实现原理"}},[t._v("#")]),t._v(" 场景说明(实现原理)")]),t._v(" "),e("p",[t._v("以上场景案例中有两类场景, 对于第一类"),e("code",[t._v("事务A更新了数据, 但未提交, 事务B也能看到")]),t._v("大家都容易理解, 与read uncommitted字面意思一样, 其实现原理是在读未提交隔离级别下, 普通select能读到buffer pool或undo log中未提交的内容, update一定是"),e("code",[t._v("先读后写")]),t._v("并且是"),e("code",[t._v("当前读")]),t._v(", 因此会出现事务B update不到事务A insert的数据(上面案例中"),e("code",[t._v("update t set d=200 where d=6;")]),t._v("affected row 0就是如此), 但insert会在索引树上插入新节点, 所以用index或primary index做条件的update会与未提交事务的锁发生阻塞(上面案例中"),e("code",[t._v("update t set d=200 where id=6")]),t._v("即此情况).")]),t._v(" "),e("h2",{attrs:{id:"read-committed"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#read-committed"}},[t._v("#")]),t._v(" read committed")]),t._v(" "),e("p",[t._v("场景案例")]),t._v(" "),e("blockquote",[e("p",[t._v("读提交的场景案例都是常见的, 在这里不一一列举了.")])]),t._v(" "),e("h3",{attrs:{id:"实现原理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#实现原理"}},[t._v("#")]),t._v(" 实现原理")]),t._v(" "),e("p",[t._v("读提交隔离级别下, 普通select是读取行中最新数据, 在执行select语句之前构建一个视图(即当前时刻数据库数据最新的快照版本), 执行完后立即释放, 最容易出现的问题是"),e("code",[t._v("不可重复读")]),t._v(", 而update/insert/delete都是基于当前读的.")]),t._v(" "),e("h2",{attrs:{id:"repeatable-read"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#repeatable-read"}},[t._v("#")]),t._v(" repeatable read")]),t._v(" "),e("p",[t._v("场景案例")]),t._v(" "),e("blockquote",[e("p",[t._v("可重复读的案例也是最常见的, 以下只举例出较难理解的场景.")])]),t._v(" "),e("h3",{attrs:{id:"为什么update会被阻塞"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#为什么update会被阻塞"}},[t._v("#")]),t._v(" 为什么update会被阻塞?")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"left"}}),t._v(" "),e("th",[t._v("session A")]),t._v(" "),e("th",[t._v("session B")]),t._v(" "),e("th",[t._v("session C")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T1")]),t._v(" "),e("td",[t._v("begin;")]),t._v(" "),e("td"),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T2")]),t._v(" "),e("td",[t._v("insert into t values(6,6,6) "),e("br"),e("strong",[t._v("(ok)")])]),t._v(" "),e("td"),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T3")]),t._v(" "),e("td"),t._v(" "),e("td",[t._v("update t set d=200 where d=7"),e("br"),e("strong",[t._v("(block)")])]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T4")]),t._v(" "),e("td"),t._v(" "),e("td"),t._v(" "),e("td",[t._v("update set d=200 where id=7"),e("br"),e("strong",[t._v("(ok)")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T5")]),t._v(" "),e("td",[t._v("rollback;")]),t._v(" "),e("td"),t._v(" "),e("td")])])]),t._v(" "),e("h3",{attrs:{id:"反证上面案例"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#反证上面案例"}},[t._v("#")]),t._v(" 反证上面案例")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"left"}}),t._v(" "),e("th",[t._v("session A")]),t._v(" "),e("th",[t._v("session B")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T1")]),t._v(" "),e("td",[t._v("begin;")]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T2")]),t._v(" "),e("td",[t._v("update t set d=200 where d=7  "),e("strong",[t._v("(Affected row: 0)")])]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T3")]),t._v(" "),e("td"),t._v(" "),e("td",[t._v("insert into t values(6,6,6);"),e("br"),t._v(" "),e("strong",[t._v("(block)")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T4")]),t._v(" "),e("td",[t._v("rollback;")]),t._v(" "),e("td")])])]),t._v(" "),e("h3",{attrs:{id:"在事务第一句select时构建一致性视图"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#在事务第一句select时构建一致性视图"}},[t._v("#")]),t._v(" 在事务第一句select时构建一致性视图")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"left"}}),t._v(" "),e("th",[t._v("session A")]),t._v(" "),e("th",[t._v("session B")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T1")]),t._v(" "),e("td",[t._v("begin;")]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T2")]),t._v(" "),e("td"),t._v(" "),e("td",[t._v("begin;")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T3")]),t._v(" "),e("td"),t._v(" "),e("td",[t._v("insert into t values(100,100,100); "),e("br"),e("strong",[t._v("(ok)")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T4")]),t._v(" "),e("td"),t._v(" "),e("td",[t._v("commit;")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("T5")]),t._v(" "),e("td",[t._v("select * from t;"),e("br"),e("strong",[t._v("(结果中包含(100,100,100)这一行)")])]),t._v(" "),e("td")])])]),t._v(" "),e("h3",{attrs:{id:"场景说明-实现原理-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#场景说明-实现原理-2"}},[t._v("#")]),t._v(" 场景说明/实现原理")]),t._v(" "),e("p",[t._v("可重复读隔离级别下, 会在事务开始后的第一句select构建整个事务使用的一致性视图(上面案例中T5时刻查询到结果即可说明), update/delete会加next-key lock, 扫描到的索引对象都会加锁(即上面案例中update被阻塞的原因).")])])}),[],!1,null,null,null);s.default=n.exports}}]);