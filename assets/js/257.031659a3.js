(window.webpackJsonp=window.webpackJsonp||[]).push([[257],{669:function(t,a,s){"use strict";s.r(a);var e=s(42),r=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"全局锁"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#全局锁"}},[t._v("#")]),t._v(" 全局锁")]),t._v(" "),s("h2",{attrs:{id:"语法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#语法"}},[t._v("#")]),t._v(" 语法")]),t._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 加全局锁")]),t._v("\nFlush "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("tables")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("with")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("read")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("lock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 释放全局锁")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unlock")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("tables")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h2",{attrs:{id:"使用场景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用场景"}},[t._v("#")]),t._v(" 使用场景")]),t._v(" "),s("ol",[s("li",[t._v("做逻辑备库")])]),t._v(" "),s("blockquote",[s("p",[t._v("使用全局锁备份时, 整个库处于只读状态, 是比较危险的.(使用mysqldump官方工具做备份, 可以实现不影响正常业务的读写, 依靠MVCC获取一致性视图实现.)")]),t._v(" "),s("p",[t._v("需要注意两个问题:")]),t._v(" "),s("blockquote",[s("ol",[s("li",[s("p",[t._v("选择主库备份, 整个业务会处于停摆状态")])]),t._v(" "),s("li",[s("p",[t._v("选择从库备份, 会导致主从延迟.")])])])])]),t._v(" "),s("h1",{attrs:{id:"表级锁"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#表级锁"}},[t._v("#")]),t._v(" 表级锁")]),t._v(" "),s("blockquote",[s("p",[t._v("表级锁分两种, 一种是表锁, 一种是元数据锁(meta data lock - MDL)")])]),t._v(" "),s("h2",{attrs:{id:"表锁"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#表锁"}},[t._v("#")]),t._v(" 表锁")]),t._v(" "),s("h3",{attrs:{id:"语法-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#语法-2"}},[t._v("#")]),t._v(" 语法")]),t._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 加表锁")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("lock")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("tables")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("read")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("lock")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("tables")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("write")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 释放锁, 客户端断开时会自动释放锁.")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unlock")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("tables")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h3",{attrs:{id:"使用注意事项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用注意事项"}},[t._v("#")]),t._v(" 使用注意事项")]),t._v(" "),s("p",[t._v("使用lock tables要注意, 此语法除了会限制其他线程读写, 也会限制"),s("code",[t._v("当前线程读写")]),t._v(".")]),t._v(" "),s("blockquote",[s("p",[t._v("如果线程A执行了lock tables t1 read, t2 write, 其他线程对t1写, t2读写都会发生阻塞, 而线程A只能读t1和读写t2, 连其他表都不能访问.")])]),t._v(" "),s("h2",{attrs:{id:"mdl"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mdl"}},[t._v("#")]),t._v(" MDL")]),t._v(" "),s("blockquote",[s("p",[t._v("DML(meta data lock)不需要显示使用, 在访问表的时候会自动加上, 用于保证读写的正确性.")]),t._v(" "),s("p",[s("strong",[t._v("对表进行任何操作都会加MDL读锁")])]),t._v(" "),s("p",[s("strong",[t._v("修改表结构时会加MDL写锁")])])]),t._v(" "),s("h3",{attrs:{id:"读写锁规则"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#读写锁规则"}},[t._v("#")]),t._v(" 读写锁规则")]),t._v(" "),s("blockquote",[s("ol",[s("li",[t._v("多个读锁可以同时使用")]),t._v(" "),s("li",[t._v("读/写锁, 写锁之间会互斥")])])])])}),[],!1,null,null,null);a.default=r.exports}}]);